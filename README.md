v2r-copter-log-place
====================

a-la бложик о том, как создаётся квадрокоптер на базе виртурилки.

Links
=====
Откуда черпается вдохновение и тырятся идеи/код.

- <https://code.google.com/p/owenquad/>


14-Dec-2013
===========
Куплена платформа DJI F450. Спаял за вечер.

15-Dec-2013
===========
Пожжужал двигателями с помощью аппаратных PWM в2р

<http://wiki.virt2real.ru/wiki/PWM>

Заказал USB-UART (на FTDI232RL), гироском+акселерометр MPU-5060, компас на HMC5883L, сонар HC-SR04

<http://ardunn.ru>

16-Dec-2013
===========
Забрал ништяки.
Подключил консоль USB-UART (3 провода + minicom)

<http://wiki.virt2real.ru/wiki/%D0%9D%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0_UART>

Теперь есть терминал без шаманства.

Подключил MPU-5060 и компас по i2c

<http://wiki.virt2real.ru/wiki/%D0%9F%D0%BE%D0%B4%D0%BA%D0%BB%D1%8E%D1%87%D0%B5%D0%BD%D0%B8%D0%B5_%D0%B4%D0%B0%D1%82%D1%87%D0%B8%D0%BA%D0%BE%D0%B2_%D0%BF%D0%BE_I2C>

Обе две железки видны в i2cdetect. 

Драйвер для MPU-6050 в ядре не нашлось (или плохо искал). Пока отложил железку в сторону.
Для HMC5883L драqвера нет, есть для HMC5843L.

В даташитах есть различия:

- Регистры чтения по Z и Y поменяны местами
- Configuration Register A использует биты 5,6 (количество семплов для усреднения)
- HMC5883L: Mode register - bit7 включить прддержку High Speed i2c (3400kHz)
- Data output rate имеют большее в 1.5 раза значение
- Чуствительность HMC5883L чють меньше
- Status Register в HMC5883L не имеет бита REN

Воткнув драйвер от HMC5843L, смог что-то прочитать из values.
Сначала всё читалось как -4096, потом 3-е значение стало менятся (около 200-300)

17-Dec-2013
===========

На свежую голову нашёл драйвер для MPU-6050
<http://forum.virt2real.ru/viewtopic.php?f=38&t=13332&start=5>

    CONFIG_INV_MPU6050_IIO:
    Location:
        -> Device Drivers
            -> Industrial I/O support (IIO [=m])


19-Dec-2013
===========

Построил ядрёный драйвер для MPU-6050, но драйвер девайса не увидел.
Симптомы похожи на то что описано тут

<https://groups.google.com/forum/#!topic/beagleboard/hqqecmOjpTU>

Думал, что девайс дохлый.

Нашёл демо для RPi
<http://www.raspberrypi.org/phpBB3/viewtopic.php?t=22266>

Построил консольные демки для в2р, заменив хардкоженный /dev/i2c-0 на /dev/i2c-1.
Данные идут, даже похожи на правду

demо_dmp может выводить квартенионы. углы Эйлера, абсалюнтые и нормализованные ускорения по осям.
Собственно, это все, что может потребоватчся от гира+акселя. 

Дэмка жрёт 40% cpu.

20-Dec-2013
===========

Для удобства работы с в2р разместил все железки на куске электрокартона.

Зацепил в2р к вайфаю в качестве клиента.

Поигрался с ADC, попутно исправил багу в админке (<https://github.com/virt2real/admin_panel/pull/1>)

Начал добавлять поддержку ioctl в драйвер ADC.
<http://tuxthink.blogspot.ru/2012/12/implementing-ioctl-call-for-kernel.html>

22-Dec-2013
===========
Сделал ioctl в драйвер ADC + семплы
- <https://github.com/eagafonov/v2r-linux-davinci/tree/v2r-adc-ioctl>
- <https://github.com/eagafonov/v2r-demos>

Начал смотреть код <https://code.google.com/p/owenquad>

Появилась мысль портировать библиотеки ArduPilot на виртурилку.

23-Dec-2013
===========
ArduPilot содержит порт для linux.

Удалось завести тест из ArduPilot для компаса. Изменений в коде библиотек ArduPilot нет вообще!!!
Столкнулся с проблемой, что порт ArduPilot для linux подключает низкоуровневые файлы (asm/...)
Если подключать фалы прямо из дерева ядра, что построение валится. После танцев с бубном решил, 
что подключать файлы из дерева ядра некошено. Документация подтверждает

<https://www.kernel.org/doc/Documentation/make/headers_install.txt>

Сделал патч для SDK чтобы можно было экспортировать заголовки. 
<https://github.com/virt2real/install-sdk/pull/3>

26-Dec-2013
===========

ковырялся с построением opkg пакетов при построении FS из v2r sdk
Что, то получается. Результаты - на форуме. 

<http://forum.virt2real.ru/viewtopic.php?f=38&t=13411>


29-Dec-2013
===========

Начал ковырять модуль MPU-6000 в сторону поддержки  MPU6050.
MPU6050 поддерживает только i2c, в то время как MPU6000 ещё и spi.

APM использует именно SPI для взаимодейстивия с модулем.
Поначалу заимел проблему - первые две команды проходят, затем не может читать/писать регистры по i2c.
Даже демка, которая раньще работала, отказывалась взаимодействовать с чипом.
Только отключение чипа приводило его в чувство.

Оказалось, что в коде после инициализации явно запрещалось чипу работать по i2c.
Часа полтора это ловил.

В результате стали валится данные. 

Ещё заметил, что в коде явно меняются местами значения по осям X и Y.
Подозреваю, что это связано с физическим размещением чипа на плате APM.

<http://ardupilot.com/forum/viewtopic.php?f=69&t=5322>


30-Dec-2013
============

На форуме подтвердили догадку, что смена значений по X и Y может быть связана с физическим размещением чипа.
Ещё заметил, что значения акселерометра и гироскопа инвертируются по Z.
Чип вверх ногами что-ли припаян?

В общем, расставил чтение в нормальном порядке и в логе увидел вразумительные значения.
По крайней мере g равно 9.8 (если не трясти), знаки значений совпадают с даташитом (если трясти и вертеть). 


01-Jan-2014
===========

С Новым Годом!

Решил пожжужать двигателями.
Спаял проводок для подключения всех 4-х ESC к макетке и решил поморгать светодидами ещё раз для
проверки праваильно ли PWM работаеют. И внезапно обнаружил, что PWM2 не работает.

Немного поковырявшись в коде, нашёл что PWM2 может на разных пинах висеть. 
Оказалось, что у меня он на другом висит и исправно работает.

Преблемку на форуме описал
<http://forum.virt2real.ru/viewtopic.php?f=38&t=13420&p=18238>


01-Feb-2014
===========

Итак, приехал мне [GY-87](http://www.ebay.com/itm/231017647381), который на борту несёт:

- акселерометр+гироскоп MPU6050
- Барометр BPM180
- Магнетометр HMC5883L

Хочу описать особенность данного модуля - сразу после включения на шине i2c не видно магнетометра.
Похоже, что аксел и барометр прицеплены к основной шине i2c, а магнетометр - на вторичной i2c шине MPU6050.

Что-то вроде этого:

	[v2r] ==o==>MPU6050 ---> HMC5883L
			\
			 \===> BPM180

После старта MPU6050 не пропускает ничего из внешней шины во вторичную, самолично пожирая тактирующий сигнал и данные.
HMC5883L ничего не получает от хоста.

По даташиту, чтобы хост увидел устройства на вторично шине,  MPU6050 надо переключить в режим i2c bypass путём установки бита 2 регистра 55
Это равносильно тому, что лини SCL и SDA обоих шин соедияются внутри  MPU6050. Как-то так.

Вот буквы из даташита

	4.15 Register 55 – INT Pin / Bypass Enable Configuration INT_PIN_CFG

	When I2C_BYPASS_EN is equal to 1 and I2C_MST_EN (Register 106 bit[5]) is equal to 0, the host
	application processor will be able to directly access the auxiliary I2C bus of the MPU-60X0. When
	this bit is equal to 0, the host application processor will not be able to directly access the auxiliary I2C
	bus of the MPU-60X0 regardless of the state of I2C_MST_EN.

Вот такая вот есть особенность MPU6050 и модуля GY-87  в частности. 
На кой ляд два девайса повесили на основную шину, а третий - на вторичную, мне не понятно.

Теперь для работы с магнетометром надо ещё аксель инициализировать.
Проблему решил, но осадок остался.

ArduPilot TODOs
===============

- MPU6050 support (done)
- MAVLink over UDP (done with dirty hacks )
- v2r PWM support (done with dirty hacks )
- GPS
- Barometer


